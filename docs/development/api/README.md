# Faction API
Faction provides two ways to access its API, REST and SocketIO. REST leverages traditional HTTP verbs to perform actions against objects. SocketIO is a transport provided over Web Sockets to allow for real-time API access. It uses message types and JSON messages to perform actions.

## Authentication
No matter the API you're using you'll need an API key to authenticate. API keys consist of a key ID and a secret and they can be used in the following ways:

* AccessKeyId and AccessSecret Cookies
* The Authorization Header. The format for this is `Authorization: token [base64 string]` where "base64 string" is the base64 value of [AccessKeyId]:[AccessSecret]
* Token GET parameter. You can append your key ID and secret to a URL in the format of `?token=[AccessKeyId]:[AccessSecret]` 

## Getting an API key
### Logging in with a username and password to get an API key.
You can post your username and password to /api/v1/login/ to get a session token API key. Its important to note that this key will be invalidated the next time your username and password is used against this endpoint.

::: tip
The login endpoint is the only endpoint in Faction that will accept a username and password for authentication. All other endpoints need to use an API key.
:::

Example:
```
curl -X POST -H "Content-Type: application/json" -d '{"Username":"USERNAME","Password":"PASSWORD"}' http://127.0.0.1:5000/api/v1/login/

{
  "AccessKeyId": "EpmuoqLMgnkm0olE", 
  "AccessSecret": "BgsbKv_TByiZHcgzqjKdJMjWe8lS2xa4_aGAAPAVdpAg4_Ef_NAm_lWdHCYw-RIF", 
  "Success": true, 
  "UserId": 2, 
  "UserRole": "admin", 
  "Username": "admin"
}
```

### Creating a new, permanent API key
If you need a long lasting API key, you can use the /api/v1/user/[user id]/apikeys endpoint.

Example:

```
curl -X POST http://127.0.0.1:5000/api/v1/user/2/apikeys/?token=API_KEY_ID:API_SECRET
{
  "Id": 4, 
  "Name": "qxkm2ey8GGBw9ur4", 
  "Secret": "GA8E1mCrlcgpB-BuqXBGYJP_qQbhVXYev2H9VNjtG39M-0FJQFUvcdNJ9GezIoRC", 
  "Success": true
}

```

## Endpoints
It is assumed that all endpoints listed here begin with `/api/v1/`

::: tip
All parameters names are Case Sensitive
:::

### Agent
Endpoint: `/api/v1/agent/[agent_id]/`

This endpoint is used to manage Faction agents. With the exception of GET, all methods require that `agent_id` be specified.

#### GET
If an agent_id is specified returns the agent, else returns a list of all agents.

#### PUT
Updates an agent (agent_id required). Valid parameters are:

|Parameter  | Description                                    |
|-----------|------------------------------------------------|
|Name       | The name of the agent                          |
|Visibility | Whether the agent is visible in Faction or not |

#### DELETE
Hides the given agent (requires an agent_id)

### Agent Staging
Endpoint: `/api/v1/agent/[staging_name]/[staging_id]/`

This endpoint is used by Transport and Agents when an payload stages with Faction. In response, Faction will return a set of agent tasks that configure an agent (name, new password, etc). The Staging Name is associated with a given payload, the staging ID is a random string generated by the payload trying to stage.

#### POST
Initiates a staging request. Valid parameters are:

|Parameter   | Description                                    |
|------------|------------------------------------------------|
|Message     | The base64 encoded message from the agent                          |
|TransportId | ID of the Transport Server that is handling this request |
|SourceIp    | The external IP address for the agent, else the IP of the transport is used (optional) |

### Agent Checkin 
Endpoint: `/api/v1/agent/[agent_name]/checkin/`

This endpoint is used by Transports and Agents when they check in. It handles returning encrypted tasks for agents and receiving encrypted task results from agents.

#### GET
Returns a JSON string containing the agent name and a base64 encoded list of [Agent Task Messages](/docs/development/schema/#agent-checkin)

#### POST 
Creates a new agent checkin. Valid parameters are:

|Parameter   | Description                                    |
|------------|------------------------------------------------|
|Message     | The base64 encoded message from the agent                          |
|TransportId | ID of the Transport Server that is handling this request |
|SourceIp    | The external IP address for the agent, else the IP of the transport is used (optional) |

### Task
Endpoint: `/api/v1/task/[task_id]/`

Used to get agent tasks. If you need to create a new agent task, use the CONSOLE API endpoint.

#### GET 
If a task_id is specified returns the given task, else returns a list of all agent tasks


### Console Message (Agent)
Endpoint: `/api/v1/agent/[agent_id]/console/`

This endpoint is used for interacting with agents in Faction. 

#### GET
Returns a lists of all console messages associated with this agent id

#### POST
Send a new console message

|Parameter  | Description                                    |
|-----------|------------------------------------------------|
|Content    | The console message to send                    |

### Console Message (Agent Task)
Endpoint: `/api/v1/task/[task_id]/console`

This endpoint is used for historical console information by task.

#### GET
Returns the console message information for a given agent task.

### Transport
Endpoint: `/api/v1/transport/[transport_id]`

This endpoint is used to list, manage, and create [Transports](/docs/development/transports/)

#### GET
If `transport_id` is specified, returns the Transport, else returns a list of all Transports

#### POST
Used to create a new Transport (can not be used with a transport_id).

|Parameter  | Description                                    |
|-----------|------------------------------------------------|
|Name       | User specified name of the transport           |

#### PUT
Used to update a Transport (requires a transport_id). This endpoint is used to update existing Transports and by Transport Servers to register with Faction 

|Parameter  | Description                                    |
|-----------|------------------------------------------------|
|Name    | User specified name of the transport                   |
|TransportType | This is the type of Transport being registered, for example the name of the Transport project (ex: Susan's super awesome carrier pigeon based transport) |
|Guid | A GUID that is unique to the Transport type, not the transport instance. This GUID should be the same across all registered instances of your Transport Type |
|Configuration | Configuration used to build the corresponding Transport Module. Things like what URL to connect to, details on how to obfuscate the traffic, etc |
|Enabled | Whether the Transport is active or not |
|Visible | Whether the Transport is visiable or not, if set to False then Enabled will also be set to False. |

#### DELETE
Sets both visible and enabled on the specified transport_id to False.